# =============================================================================
# QBM CI Workflow - Phase 11
# =============================================================================
# Tier A tests run on every push/PR (CPU-only, no GPU, no PyG)
# Tier B tests require self-hosted runner with GPU + QBM_FULLPOWER_READY=1
# =============================================================================
name: QBM CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  # Phase 10.1d: PyG is opt-in only - disabled in CI by default
  # This prevents Windows DLL crashes and ensures clean builds
  QBM_ENABLE_PYG: "0"
  # Disable GPU for CI (Tier A tests are CPU-only)
  CUDA_VISIBLE_DEVICES: ""

jobs:
  # ===========================================================================
  # Tier A: CPU/Fixture Tests (runs everywhere)
  # ===========================================================================
  tier-a-tests:
    name: Tier A Tests (CPU-only)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.11"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify PyG is disabled
        run: |
          echo "QBM_ENABLE_PYG=$QBM_ENABLE_PYG (should be 0)"
          python -c "import os; assert os.getenv('QBM_ENABLE_PYG', '0') != '1', 'PyG should be disabled in CI'"
      
      - name: Run Tier A tests (CPU-only, no GPU, no PyG)
        run: |
          python -m pytest tests/ -v --tb=short \
            -m "not gpu and not slow and not tier_b" \
            --ignore=tests/test_end_to_end.py \
            --ignore=tests/test_scholarly_spotcheck.py
      
      - name: Check test collection
        run: |
          python -m pytest --collect-only tests/ -q

      - name: Benchmark smoke (proof-only)
        run: |
          python scripts/run_qbm_benchmark.py \
            --dataset data/benchmarks/qbm_legendary_200.v1.jsonl \
            --smoke \
            --proof-only \
            --ci

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run ruff check
        run: |
          ruff check src/ tests/ --ignore=E501,F401,F841 --exit-zero

  # ===========================================================================
  # Repo Hygiene: Check for Windows reserved filenames
  # ===========================================================================
  repo-hygiene:
    name: Repo Hygiene Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for Windows reserved filenames
        run: |
          # Windows reserved names that poison repos
          RESERVED="nul con prn aux com1 com2 com3 com4 com5 com6 com7 com8 com9 lpt1 lpt2 lpt3 lpt4 lpt5 lpt6 lpt7 lpt8 lpt9"
          
          echo "Checking for Windows reserved filenames..."
          FOUND=""
          for name in $RESERVED; do
            # Check for exact matches (case-insensitive)
            MATCHES=$(find . -iname "$name" -o -iname "$name.*" 2>/dev/null | grep -v ".git/" || true)
            if [ -n "$MATCHES" ]; then
              echo "ERROR: Found reserved filename '$name': $MATCHES"
              FOUND="$FOUND $MATCHES"
            fi
          done
          
          if [ -n "$FOUND" ]; then
            echo "::error::Windows reserved filenames found:$FOUND"
            exit 1
          fi
          
          echo "✅ No Windows reserved filenames found"

  # ===========================================================================
  # Audit Pack Generation and Validation (Enterprise Mode)
  # ===========================================================================
  audit-pack:
    name: Audit Pack Generation
    runs-on: ubuntu-latest
    needs: [tier-a-tests, lint]  # Only run after tests pass
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify clean tree
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ERROR: Working tree is not clean"
            git status --porcelain
            exit 1
          fi
          echo "✅ Working tree is clean"
      
      - name: Generate audit pack (strict mode)
        run: |
          python scripts/generate_audit_pack.py --strict
      
      - name: Validate audit pack (CI mode)
        env:
          QBM_REQUIRE_AUDIT_PACK: "1"
        run: |
          python -m pytest tests/test_audit_pack_phase7.py -v --tb=short -k "audit_pack"
      
      - name: Package audit pack
        run: |
          cd artifacts
          zip -r audit_pack.zip audit_pack/
      
      - name: Upload audit pack artifact
        uses: actions/upload-artifact@v4
        with:
          name: audit-pack-${{ github.sha }}
          path: artifacts/audit_pack.zip
          retention-days: 90

  # ===========================================================================
  # Frontend E2E Tests (Playwright)
  # ===========================================================================
  frontend-e2e:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: qbm-frontendv3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: qbm-frontendv3/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Build frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
      
      - name: Run Playwright tests
        run: npx playwright test --reporter=list
        continue-on-error: true  # Don't fail CI on E2E failures (smoke test only)
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: qbm-frontendv3/playwright-report/
          retention-days: 7
