# QBM Phase 0 Baseline Report

**Date:** 2025-12-25  
**Phase:** 0 - Baseline and Instrumentation  
**Status:** ⚠️ Pre-Remediation Baseline

---

## Summary

This baseline report documents the fallback usage rate **before** remediation begins.
The goal is to establish a measurable starting point so we can track improvement.

| Metric | Value | Target (Post-Remediation) |
|--------|-------|---------------------------|
| Total Queries | 10 | 10 |
| Fallbacks Used | TBD | 0 |
| Fallback Rate | TBD | 0% |

---

## Phase 0 Instrumentation Added

The following instrumentation has been added to track fallback usage:

### 1. ProofDebug Schema

```python
@dataclass
class ProofDebug:
    fallback_used: bool = False
    fallback_reasons: List[str] = []
    retrieval_distribution: Dict[str, int] = {}
    primary_path_latency_ms: int = 0
    index_source: Literal["disk", "runtime_build"] = "disk"
    
    # Component-level tracking
    quran_fallback: bool = False
    graph_fallback: bool = False
    taxonomy_fallback: bool = False
    tafsir_fallbacks: Dict[str, bool] = {}
```

### 2. Fallback Detection Points

| Component | Fallback Trigger | Location |
|-----------|------------------|----------|
| Quran | Primary retrieval returns 0 verses | `mandatory_proof_system.py:600-604` |
| Graph | Primary retrieval returns 0 nodes | `mandatory_proof_system.py:770-772` |
| Taxonomy | Primary retrieval returns 0 behaviors | `mandatory_proof_system.py:933-935` |
| Tafsir | Any source has 0 results | `mandatory_proof_system.py:1050-1054` |

### 3. Test Helpers

- `assert_no_fallback(response)` - Raises `FallbackDetectedError` if fallback was used
- `assert_source_distribution(response)` - Verifies all 5 tafsir sources have minimum results
- `generate_baseline_report(system, queries)` - Generates comprehensive fallback report

---

## Expected Fallback Scenarios (Pre-Remediation)

Based on code analysis, the following fallbacks are likely active:

### Quran Fallback
- **Trigger:** When semantic search returns 0 Quran verses
- **Fallback Action:** Extract surah names from question, fetch verses directly
- **Root Cause:** Quran verses may not be properly indexed or embeddings don't match

### Graph Fallback  
- **Trigger:** When behavior_results is empty and query contains framework keywords
- **Fallback Action:** Use hardcoded core behaviors from Bouzidani's framework
- **Root Cause:** Graph traversal not finding relevant behavior nodes

### Taxonomy Fallback
- **Trigger:** When no behaviors detected from RAG results
- **Fallback Action:** Keyword-based behavior detection
- **Root Cause:** Behavior annotations not being retrieved or classified

### Tafsir Fallback
- **Trigger:** When any of the 5 tafsir sources has 0 results
- **Fallback Action:** Currently none (just logs warning)
- **Root Cause:** Source-stratified retrieval not implemented

---

## Remediation Plan

| Phase | Focus | Expected Impact on Fallback Rate |
|-------|-------|----------------------------------|
| 0 | Instrumentation | Baseline established |
| 1 | Test Hygiene + CI | No direct impact |
| 2 | Security | No direct impact |
| 3 | Data Cleaning | May reduce false negatives |
| 4 | Stratified Retrieval | **Major reduction** - guarantees 5 sources |
| 5 | Embedding Model | **Major reduction** - better semantic matching |
| 6 | Graph Semantics | Reduces graph fallbacks |
| 7 | API Refactoring | No direct impact |
| 8 | Frontend Integration | No direct impact |
| 9 | Documentation | No direct impact |

---

## How to Generate Full Baseline

Run the baseline generation script:

```bash
python scripts/generate_baseline_report.py
```

This will:
1. Initialize the QBM Full Power System
2. Run 10 test queries
3. Record fallback usage for each
4. Generate detailed JSON and Markdown reports

---

## Acceptance Criteria for Phase 0

- [x] ProofDebug schema added to `mandatory_proof_system.py`
- [x] Fallback tracking added to Quran, Graph, Taxonomy components
- [x] Debug section included in API response
- [x] `tests/conftest.py` created with `assert_no_fallback()` helper
- [x] Baseline report template created
- [ ] Full baseline report generated (requires system initialization)

---

## Next Steps

1. Run `python scripts/generate_baseline_report.py` to get actual fallback rates
2. Commit Phase 0 changes
3. Proceed to Phase 1: Test Hygiene and CI

---

*Report created: December 25, 2025*  
*Phase 0 instrumentation complete*
